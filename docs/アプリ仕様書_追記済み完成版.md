学宝クイズアプリ「ドキドキ!クイズチャレンジ」仕様書
========================================================

作成日: 2025年12月25日
更新日: 2025年12月25日
作成者: 沼
バージョン: 1.1.0（追記済み完成版）


1. プロジェクト概要
-------------------

1.1 アプリ名称
・正式名称: ドキドキ!クイズチャレンジ
・プロジェクト名: gakuho-quiz-app
・マスコットキャラクター: がくまる

1.2 目的
中学生向けの学習クイズアプリ。5教科（国語・社会・数学・理科・英語）の問題を
クイズ形式で出題し、楽しみながら学習できる環境を提供する。

1.3 ターゲットユーザー
・中学生（12〜15歳）
・スマートフォン利用が前提
・SNS（LINE, X, Instagram）を日常的に利用する層

1.4 GitHub
https://github.com/numaken/gakuho-app


2. 技術構成
-----------

2.1 開発フレームワーク

本アプリはReact Native + Expoを採用している。

選定理由:
・iOS/Androidの両プラットフォームを単一コードベースで開発可能
・Expoによる開発効率の向上（ビルド、配布、OTA更新）
・TypeScriptによる型安全性の確保
・豊富なエコシステムとコミュニティサポート

2.2 技術スタック一覧

カテゴリ          | 技術/ライブラリ           | バージョン | 用途
-----------------|--------------------------|-----------|---------------------------
ランタイム        | Node.js                  | 18以上    | 開発環境
フレームワーク    | Expo SDK                 | 54.0.30   | React Nativeの開発基盤
UI               | React Native             | 0.81.5    | クロスプラットフォームUI
言語             | TypeScript               | 5.9.2     | 型安全なJavaScript
ルーティング      | expo-router              | 6.0.21    | ファイルベースルーティング
バックエンド      | Supabase                 | -         | データベース・認証
バックエンド      | Supabase Edge Functions     | -         | AI診断・サーバ処理（OpenAIキー保持）
ローカルストレージ | AsyncStorage             | -         | 端末内データ保存
AI              | OpenAI（gpt-4o-mini）       | -         | 成績診断・講評生成（Edge Function経由）
画像生成         | react-native-view-shot   | -         | 結果画像の生成
シェア機能       | expo-sharing             | -         | SNSシェア
QRコード         | react-native-qrcode-svg  | -         | QRコード生成
音声             | expo-av                  | -         | 効果音再生
触覚             | expo-haptics             | -         | バイブレーション

2.3 ビルド・配布

・ビルドサービス: EAS Build（Expo Application Services）
・配布方法: 社内配布（Ad Hoc）
・iOS: Ad Hoc配布（デバイス登録制）
・Android: APKファイル配布


3. システム構成図
-----------------

3.1 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                      ユーザー端末                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              React Native アプリ                     │   │
│  │  ・expo-router（画面）                               │   │
│  │  ・hooks / utils                                     │   │
│  │  ・AsyncStorage（端末内保存）                         │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTPS
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                         Supabase                              │
│  ┌─────────────────┐   ┌─────────────────────────────────┐  │
│  │ Postgres (DB)   │   │ Edge Functions                   │  │
│  │ ・questions      │   │ ・ai_feedback（AI成績診断）      │  │
│  │ ・high_scores    │   │   └ OpenAIへ接続（キーは保持）  │  │
│  │ ・user_profiles  │   │ ※アプリ→OpenAI直結は禁止         │  │
│  │ ・user_stats     │   └─────────────────────────────────┘  │
│  │ ・RLS/Policy     │                                         │
│  └─────────────────┘                                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTPS（Edge Functionsのみ）
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                         OpenAI API                           │
│  ・モデル: gpt-4o-mini                                       │
│  ・用途: 講評/強み/弱み/アドバイス生成                       │
└─────────────────────────────────────────────────────────────┘
```

3.2 ディレクトリ構成

```
gakuho-quiz-app/
├── app/                    # 画面コンポーネント（expo-router）
│   ├── _layout.tsx         # 共通レイアウト
│   ├── index.tsx           # ホーム画面
│   ├── nickname.tsx        # ニックネーム登録画面
│   ├── mode-select.tsx     # モード選択画面
│   ├── quiz.tsx            # クイズ出題画面
│   ├── result.tsx          # 結果表示画面
│   ├── ranking.tsx         # ランキング画面
│   ├── mypage.tsx          # マイページ画面
│   └── invite.tsx          # 招待画面
├── components/             # 再利用可能なUIコンポーネント
│   ├── Button.tsx          # 共通ボタン
│   ├── Timer.tsx           # タイマー表示
│   ├── QuestionCard.tsx    # 問題カード
│   ├── DiagnosisCard.tsx   # AI診断カード
│   ├── ShareCard.tsx       # シェア用カード
│   ├── ShareModal.tsx      # シェアモーダル
│   └── MaterialList.tsx    # 教材リスト（未使用）
├── hooks/                  # カスタムフック
│   ├── useTimer.ts         # タイマーロジック
│   └── useQuizLogic.ts     # クイズ進行ロジック
├── utils/                  # ユーティリティ関数
│   ├── storage.ts          # ローカルストレージ操作
│   ├── supabase.ts         # Supabase接続
│   ├── openai.ts           # OpenAI API連携
│   ├── scoring.ts          # スコア計算
│   ├── feedback.ts         # 触覚・音声フィードバック
│   └── share.ts            # シェア機能
├── data/                   # 静的データ
│   └── questions.ts        # 問題データ（フォールバック用）
├── types/                  # 型定義
│   └── index.ts            # 共通型定義
├── assets/                 # 画像・アイコン
│   ├── logo.png            # 学宝社ロゴ
│   ├── gakumaru.png        # マスコットキャラクター
│   ├── icon.png            # アプリアイコン
│   └── splash.png          # スプラッシュ画面
└── docs/                   # ドキュメント
    ├── 社内配布ガイド.md
    ├── qr_android.png
    └── qr_ios.png
```


4. 画面仕様
-----------

4.1 画面遷移図

```
[起動]
   │
   ▼
[ニックネーム登録] ←── 初回起動時のみ
   │
   ▼
[ホーム画面] ←────────────────────────┐
   │                                  │
   ├──→ [モード選択] ──→ [クイズ] ──→ [結果] ──→ [シェア]
   │         │                           │
   │         └── 教科選択                │
   │         └── 制限時間選択            │
   │                                     │
   ├──→ [ランキング]                     │
   │                                     │
   └──→ [マイページ] ←───────────────────┘
             │
             └── 成績確認
             └── ニックネーム変更
```

4.2 各画面の詳細

4.2.1 ホーム画面（index.tsx）
・学宝社ロゴとアプリタイトルを表示
・マスコット「がくまる」を表示
・「クイズスタート」ボタン → モード選択画面へ
・「ランキング」ボタン → ランキング画面へ
・「マイページ」ボタン → マイページ画面へ

4.2.2 ニックネーム登録画面（nickname.tsx）
・初回起動時のみ表示
・ニックネームを入力（任意）
・デバイスIDを自動生成（ユーザーには非表示）
・入力後、ホーム画面へ遷移

4.2.3 モード選択画面（mode-select.tsx）
・クイズモード選択: 通常モード / 苦手克服モード
・教科選択: 国語・社会・数学・理科・英語（複数選択可）
・制限時間選択: 5秒 / 10秒 / 30秒 / 60秒
・「スタート」ボタン → クイズ画面へ

4.2.4 クイズ画面（quiz.tsx）
・問題文と4択の選択肢を表示
・タイマー表示（プログレスバー形式）
・進捗表示（例: 3 / 10）
・正解/不正解のフィードバック（色、バイブレーション）
・一時停止ボタン（⏸）→ 問題を隠してタイマー停止
・終了ボタン（✕）→ 確認ダイアログ後、ホームへ

4.2.5 結果画面（result.tsx）
・グレード表示（S/A/B/C/D）
・スコア、正解数、正答率を表示
・AI診断（がくまるからのアドバイス）
・「苦手分野をもう一度挑戦!」ボタン（間違えた教科で補習クイズ）
・「結果をシェア」ボタン → シェアモーダル
・「もう一度」「トップへ」ボタン

4.2.6 ランキング画面（ranking.tsx）
・期間切り替え: 週間 / 月間 / 累計
・順位、ニックネーム、スコアを一覧表示
・自分の順位をハイライト

4.2.7 マイページ画面（mypage.tsx）
・ニックネーム表示・変更
・総合成績（総問題数、正解数、正答率）
・教科別成績（attempts/正解数/正答率）
・招待QRコード生成（invite_code ベース）
・サポート用ID（device_id）表示・コピー
  - 削除依頼・不具合調査時の照合キーとして使用

4.2.8 招待画面（invite.tsx）
・招待用QRコードの表示（ディープリンク/招待コード含む）
・招待メッセージの生成（テキストでコピー/共有）
・システムシェアシート（LINE等）から送信可能
・戻るでマイページへ




5. 機能仕様
-----------

5.1 クイズ機能

5.1.1 出題ロジック
・選択された教科から問題を出題
・1セッション10問
・通常モード: ランダム出題
・苦手克服モード: 過去に間違えた問題を優先出題

5.1.2 スコア計算
・正解1問につき基礎点100点（BASE_POINT=100）
・各問題の得点（正解時のみ）:
  - timeBonus = 1 + (1 - timeSpent/timeLimit)  ※最大2倍（早いほど高い）
  - difficultyBonus = difficulty（1〜3）
  - questionScore = round( BASE_POINT × timeBonus × difficultyBonus )
・合計スコア = 全問題の questionScore の合計
・最高スコアを記録（モード×教科組合せ×制限時間ごとに保持）




5.1.3 タイマー機能（useTimer.ts）
・選択した制限時間でカウントダウン
・時間切れ時は不正解として処理
・一時停止・再開が可能

5.2 AI成績診断機能

5.2.1 目的
・クイズ結果から「講評」「強み」「弱み」「次の学習アドバイス」を自動生成し、学習継続を促す。

5.2.2 処理フロー（必須：Edge Function 経由）
1. クイズ終了時に回答データを集計（教科別正答率、総合正答率、スコア）
2. アプリ → Supabase Edge Function `ai_feedback` を呼び出し（HTTPS）
3. Edge Function が OpenAI API を呼び出し（OpenAIキーは Supabase secrets に保持）
4. 返却されたJSONを結果画面に表示
5. APIエラー/タイムアウト時は定型文フォールバックを表示（アプリ側で保持）

※重要：アプリ（端末）から OpenAI API を直接呼ばない（キー漏洩リスクのため）

5.2.3 Edge Function I/F 仕様（ai_feedback）
■ Input（アプリ→Edge Function）
- `subjectScores`: 教科別集計（問題文・選択肢・問題IDは送らない）
  - `subject`: "japanese" | "social" | "math" | "science" | "english"
  - `subjectName`: "国語" など
  - `correct`: 正解数
  - `total`: 出題数
  - `rate`: 正答率（%）
- `totalRate`: 総合正答率（%）
- `totalScore`: スコア（点）

例:
```json
{
  "subjectScores": [
    {"subject":"math","subjectName":"数学","correct":6,"total":10,"rate":60}
  ],
  "totalRate": 70,
  "totalScore": 980
}
```

■ Output（Edge Function→アプリ）
- `comment`: 全体講評（150〜250文字程度）
- `strengths`: 強み（0〜3件）
- `weaknesses`: 弱み（0〜3件）
- `advice`: 次の学習アドバイス（80〜150文字程度）

例:
```json
{
  "comment": "…",
  "strengths": ["…"],
  "weaknesses": ["…"],
  "advice": "…"
}
```

5.2.4 文章トーン・制約
・中学生に分かりやすい文体（「〜だね」「〜しよう」中心）
・否定的/攻撃的な表現は禁止
・個人情報を要求しない/含めない
・出力はJSONのみ（余計なテキストを付与しない）

5.2.5 失敗時（フォールバック）
・OpenAI APIエラー/タイムアウト/不正JSON時は、アプリ側の定型文を表示
・ユーザー体験を止めない（必ず結果画面は表示される）


5.3 補習クイズ機能（敗者復活戦）

・結果画面で間違えた問題がある場合に表示
・間違えた教科から苦手克服モードでクイズを開始
・外部教材誘導ではなくアプリ内で完結

5.4 一時停止・中断機能

5.4.1 一時停止
・右上の「⏸」ボタンで発動
・タイマーを停止
・問題をモーダルで隠す（カンニング防止）
・「再開する」ボタンで続行

5.4.2 中断
・右上の「✕」ボタンで発動
・確認ダイアログ「本当にやめますか？」
・「やめる」選択でホーム画面へ戻る
・途中経過は保存されない

5.5 シェア機能

5.5.1 結果画像生成
・react-native-view-shotで画面をキャプチャ
・スコア、正答率、マスコット「がくまる」を含むデザイン

5.5.2 SNSシェア
・expo-sharingでシステムシェアシートを表示
・LINE、X、Instagram等へ共有可能

5.5.3 招待機能
・アプリ招待用QRコードを生成
・ディープリンクで招待

5.6 ランキング機能

5.6.1 目的
・学習のモチベーション向上のため、スコア上位者を表示する（匿名表示）。
・友達間ランキングや個別対戦は実装しない（いじめ等のリスク回避）。

5.6.2 仕様
・ランキングは Supabase の `high_scores` と `user_profiles` を参照して表示
・表示名は `user_profiles.nickname`（匿名ニックネーム）
・同一デバイス（device_id）から複数レコードがある場合、期間内の「最高スコア」を採用
・表示件数: デフォルト50件（UI上で最大100件程度を想定）

5.6.3 集計期間（現状実装に合わせる）
・週間: 直近7日（now - 7 days 以降の `created_at`）
・月間: 直近1ヶ月（now - 1 month 以降の `created_at`）
・累計: 全期間

※ `created_at` はUTC保存。期間フィルタは ISO8601 で比較する。

5.6.4 不正対策（リリース前必須）
・`device_id` は識別子であり認証ではない（改ざん可能）
・書き込み経路（最低限どちらかを必須）
  A) スコア登録を Edge Function 経由にし、レート制限・異常値遮断を行う（推奨）
  B) Supabase RLS/Policy で insert を安全に制御できる認証方式（例：Anonymous Auth）へ移行する


6. データ設計
------------

6.1 ローカルストレージ（AsyncStorage）

ストレージキー（utils/storage/constants.ts）:
- `@gakuho_quiz_device_id`        : 端末識別ID（UUID）
- `@gakuho_quiz_user_profile`     : ユーザープロファイル（nickname / inviteCode / createdAt / deviceId）
- `@gakuho_quiz_user_data`        : 学習データ（highScores / questionStats など）
- `@gakuho_quiz_last_result`      : 直近のクイズ結果（結果画面復元用）
- `@gakuho_quiz_custom_questions` : カスタム問題（必要時）

6.2 Supabase テーブル

6.2.1 questions（問題データ）
・id: UUID（PK）
・subject: text（japanese/social/math/science/english）
・question: text
・choices: text[] or jsonb（選択肢）
・correct_index: int
・difficulty: int（1〜3）
・created_at: timestamptz

備考:
・アプリは原則 Supabase から取得。ネットワーク不調時はローカルフォールバック（utils/questions.ts）を使用。

6.2.2 user_profiles（ユーザープロファイル）
・device_id: text（PK）
・nickname: text
・invite_code: text
・created_at: timestamptz
・updated_at: timestamptz（任意）

備考:
・ランキング表示名は user_profiles.nickname を参照
・不適切表現はアプリ側でバリデーション（禁止語/NGパターン）

6.2.3 high_scores（スコア履歴）
・id: UUID（PK）
・device_id: text（FK -> user_profiles.device_id）
・mode: text（normal / weak など）
・score: int
・created_at: timestamptz

備考:
・ランキングは期間内の highest score をデバイスごとに採用（重複排除）
・書き込みは「Edge Function 経由」または「安全なRLS/認証」で保護（出荷条件）

6.2.4 user_stats（問題別学習統計）
・device_id: text（PKの一部）
・question_id: UUID（PKの一部）
・attempts: int
・correct: int
・updated_at: timestamptz

備考:
・`onConflict: device_id,question_id` で upsert
・苦手問題判定:
  - attempts >= 3 かつ (1 - correct/attempts) >= 0.5

6.3 インデックス（推奨）
・high_scores: (mode, created_at), (device_id, created_at)
・user_stats: (device_id), (question_id)
・questions: (subject), (difficulty)



7. セキュリティ・プライバシー
----------------------------

7.1 ユーザー識別（※認証ではない）
・メールアドレス不要（中学生への配慮）
・ニックネーム制（任意入力）
・端末側で生成する `device_id` により“識別”する（改ざん可能なため「認証」とは呼ばない）

7.2 収集データの最小化
・取得しない: 氏名/住所/学校名/電話番号/メール/位置情報/連絡先
・取得する: ニックネーム（任意）, device_id（内部識別）, 学習統計（正解/不正解, スコア）

7.3 OpenAI連携における安全設計（必須）
・アプリ（端末）に OpenAI APIキーを含めない
・OpenAI呼び出しは Supabase Edge Function のみが実施（secrets にキー保管）
・送信データは「集計値のみ」（問題文・選択肢・個別ログは送らない）
・API失敗時はフォールバックでUXを維持

7.4 データ削除（COPPA相当の配慮）
・削除依頼の導線をアプリ内に用意（マイページに「サポート用ID＝device_id」を表示・コピー）
・削除対象:
  - user_profiles / high_scores / user_stats（device_idで特定）
・削除依頼の受付先: 学宝社サポート窓口（社内運用に合わせる）

7.5 不正・荒らし対策（リリース前必須）
・ランキング/スコア投稿は改ざん・連投の対象になりやすい
・対策（最低限どちらかを満たす）:
  A) 書き込みを Edge Function 経由に統一し、レート制限・異常値遮断・簡易ブラックリストを実装
  B) Supabase Auth（Anonymous Sign-in など）を導入し、RLS を `auth.uid()` ベースで構成

7.6 ログ・監視（推奨）
・Edge Function のエラー率/タイムアウト/レート制限発火状況をログで把握
・異常値（極端に高いスコア、短時間連投）を検知できるようにする


8. 開発・運用
-------------

8.1 開発コマンド

```
npm install              # 依存関係インストール
npm start                # Expo開発サーバー起動
npm run ios              # iOSシミュレータ起動
npm run android          # Androidエミュレータ起動
```

8.2 ビルド・配布

```
eas build --platform all --profile preview    # プレビュービルド
eas build --platform all --profile production # 本番ビルド
```

8.3 社内配布フロー

1. ビルド完了後、docs/qr_android.png と qr_ios.png を更新
2. SlackでQRコード画像を共有
3. テスターは端末でQRコードをスキャン
4. 表示されたリンクからインストール

8.4 問題データ管理

・問題の追加・編集・削除は学宝社ダッシュボードで実施
・アプリはSupabaseから問題データを取得
・フォールバック用にローカルにも問題データを保持



8.5 Release Gate（出荷条件）
・アプリ内に OpenAI APIキーが存在しない（ビルド成果物/ENVの確認）
・AI成績診断は Edge Function 経由になっている（アプリ→OpenAI直叩き禁止）
・Edge Function ai_feedback の要件:
  - 入力サイズ制限（集計データのみ）
  - タイムアウト/失敗時フォールバック（結果画面が必ず出る）
  - レート制限（最低限：device_id単位で短時間連投を抑止）
・ランキング/スコア投稿の不正対策が有効（7.5の A または B を満たす）
・削除依頼手順が社内でリハーサル済み（device_id取得→DB削除）
・主要導線のクラッシュがない（ホーム→クイズ→結果→シェア/ランキング）

8.6 QA・受入基準（最小チェックリスト）
機能:
- ニックネーム未登録時は登録画面へ誘導される
- 5教科/複数教科/時間制限/出題数の組合せでクイズが成立する
- 一時停止/中断が想定通り動作する
- 苦手克服モードで「弱点問題優先」が効く（attempts>=3 & errorRate>=0.5）
- 結果画面でAI講評が表示される（失敗時は定型文で代替）
- 画像シェアがOSの共有シートで実行できる
- ランキング表示が崩れない（週/月/累計の切替）

非機能:
- オフライン時に落ちない（問題はローカルフォールバック）
- 起動時のローディングが長い場合もUIが固まらない
- 端末の時計変更に依存して異常動作しない（期間集計はUTC比較を優先）
- 例外発生時にユーザー操作が止まらない（try/catch, エラーメッセージ）


9. 今後の拡張計画
-----------------

フェーズ1（完了）: 基本機能の完成
フェーズ2（完了）: AI成績診断実装
フェーズ3（完了）: シェア機能・ランキング実装
フェーズ3.5（完了）: 補習クイズ機能、一時停止・中断機能
フェーズ4: 苦手克服オンライン教材の開発
フェーズ5: 問題数拡充、学校単位での導入対応


10. 変更履歴
------------

日付         | 変更内容
------------|--------------------------------------------------
2025-12-25  | 初版作成
2025-12-25  | AI成績診断機能追加
2025-12-25  | シェア機能・ランキング・マイページ実装
2025-12-25  | 管理画面削除（ダッシュボードで管理）
2025-12-25  | 補習クイズ機能・一時停止/中断機能実装
2025-12-25  | 副教材レコメンド機能削除（補習クイズに置換）
2025-12-25  | 追記済み完成版（Edge Function経由のAI診断、ランキング集計仕様明確化、Release Gate/QA追加、データ設計・セキュリティ強化）


以上