学宝クイズアプリ「ドキドキ!クイズチャレンジ」仕様書
========================================================

作成日: 2025年12月25日
作成者: 沼
バージョン: 1.0.0


1. プロジェクト概要
-------------------

1.1 アプリ名称
・正式名称: ドキドキ!クイズチャレンジ
・プロジェクト名: gakuho-quiz-app
・マスコットキャラクター: がくまる

1.2 目的
中学生向けの学習クイズアプリ。5教科（国語・社会・数学・理科・英語）の問題を
クイズ形式で出題し、楽しみながら学習できる環境を提供する。

1.3 ターゲットユーザー
・中学生（12〜15歳）
・スマートフォン利用が前提
・SNS（LINE, X, Instagram）を日常的に利用する層

1.4 GitHub
https://github.com/numaken/gakuho-app


2. 技術構成
-----------

2.1 開発フレームワーク

本アプリはReact Native + Expoを採用している。

選定理由:
・iOS/Androidの両プラットフォームを単一コードベースで開発可能
・Expoによる開発効率の向上（ビルド、配布、OTA更新）
・TypeScriptによる型安全性の確保
・豊富なエコシステムとコミュニティサポート

2.2 技術スタック一覧

カテゴリ          | 技術/ライブラリ           | バージョン | 用途
-----------------|--------------------------|-----------|---------------------------
ランタイム        | Node.js                  | 18以上    | 開発環境
フレームワーク    | Expo SDK                 | 54.0.30   | React Nativeの開発基盤
UI               | React Native             | 0.81.5    | クロスプラットフォームUI
言語             | TypeScript               | 5.9.2     | 型安全なJavaScript
ルーティング      | expo-router              | 6.0.21    | ファイルベースルーティング
バックエンド      | Supabase                 | -         | データベース・認証
ローカルストレージ | AsyncStorage             | -         | 端末内データ保存
AI              | OpenAI GPT-4o-mini        | -         | 成績診断・講評生成
画像生成         | react-native-view-shot   | -         | 結果画像の生成
シェア機能       | expo-sharing             | -         | SNSシェア
QRコード         | react-native-qrcode-svg  | -         | QRコード生成
音声             | expo-av                  | -         | 効果音再生
触覚             | expo-haptics             | -         | バイブレーション

2.3 ビルド・配布

・ビルドサービス: EAS Build（Expo Application Services）
・配布方法: 社内配布（Ad Hoc）
・iOS: Ad Hoc配布（デバイス登録制）
・Android: APKファイル配布


3. システム構成図
-----------------

3.1 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                      ユーザー端末                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              React Native アプリ                     │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │   │
│  │  │  画面   │ │コンポー │ │  Hooks  │ │  Utils  │   │   │
│  │  │ (app/) │ │ネント   │ │         │ │         │   │   │
│  │  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘   │   │
│  │       └──────────┴──────────┴──────────┘           │   │
│  │                        │                            │   │
│  │              ┌─────────┴─────────┐                  │   │
│  │              │   AsyncStorage    │                  │   │
│  │              │  (ローカル保存)    │                  │   │
│  │              └───────────────────┘                  │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTPS
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      外部サービス                            │
│  ┌─────────────────┐              ┌─────────────────┐      │
│  │    Supabase     │              │   OpenAI API    │      │
│  │  ・問題データ    │              │  ・成績診断     │      │
│  │  ・成績データ    │              │  ・講評生成     │      │
│  │  ・ランキング    │              │                 │      │
│  └─────────────────┘              └─────────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

3.2 ディレクトリ構成

```
gakuho-quiz-app/
├── app/                    # 画面コンポーネント（expo-router）
│   ├── _layout.tsx         # 共通レイアウト
│   ├── index.tsx           # ホーム画面
│   ├── nickname.tsx        # ニックネーム登録画面
│   ├── mode-select.tsx     # モード選択画面
│   ├── quiz.tsx            # クイズ出題画面
│   ├── result.tsx          # 結果表示画面
│   ├── ranking.tsx         # ランキング画面
│   ├── mypage.tsx          # マイページ画面
│   └── invite.tsx          # 招待画面
├── components/             # 再利用可能なUIコンポーネント
│   ├── Button.tsx          # 共通ボタン
│   ├── Timer.tsx           # タイマー表示
│   ├── QuestionCard.tsx    # 問題カード
│   ├── DiagnosisCard.tsx   # AI診断カード
│   ├── ShareCard.tsx       # シェア用カード
│   ├── ShareModal.tsx      # シェアモーダル
│   └── MaterialList.tsx    # 教材リスト（未使用）
├── hooks/                  # カスタムフック
│   ├── useTimer.ts         # タイマーロジック
│   └── useQuizLogic.ts     # クイズ進行ロジック
├── utils/                  # ユーティリティ関数
│   ├── storage.ts          # ローカルストレージ操作
│   ├── supabase.ts         # Supabase接続
│   ├── openai.ts           # OpenAI API連携
│   ├── scoring.ts          # スコア計算
│   ├── feedback.ts         # 触覚・音声フィードバック
│   └── share.ts            # シェア機能
├── data/                   # 静的データ
│   └── questions.ts        # 問題データ（フォールバック用）
├── types/                  # 型定義
│   └── index.ts            # 共通型定義
├── assets/                 # 画像・アイコン
│   ├── logo.png            # 学宝社ロゴ
│   ├── gakumaru.png        # マスコットキャラクター
│   ├── icon.png            # アプリアイコン
│   └── splash.png          # スプラッシュ画面
└── docs/                   # ドキュメント
    ├── 社内配布ガイド.md
    ├── qr_android.png
    └── qr_ios.png
```


4. 画面仕様
-----------

4.1 画面遷移図

```
[起動]
   │
   ▼
[ニックネーム登録] ←── 初回起動時のみ
   │
   ▼
[ホーム画面] ←────────────────────────┐
   │                                  │
   ├──→ [モード選択] ──→ [クイズ] ──→ [結果] ──→ [シェア]
   │         │                           │
   │         └── 教科選択                │
   │         └── 制限時間選択            │
   │                                     │
   ├──→ [ランキング]                     │
   │                                     │
   └──→ [マイページ] ←───────────────────┘
             │
             └── 成績確認
             └── ニックネーム変更
```

4.2 各画面の詳細

4.2.1 ホーム画面（index.tsx）
・学宝社ロゴとアプリタイトルを表示
・マスコット「がくまる」を表示
・「クイズスタート」ボタン → モード選択画面へ
・「ランキング」ボタン → ランキング画面へ
・「マイページ」ボタン → マイページ画面へ

4.2.2 ニックネーム登録画面（nickname.tsx）
・初回起動時のみ表示
・ニックネームを入力（任意）
・デバイスIDを自動生成（ユーザーには非表示）
・入力後、ホーム画面へ遷移

4.2.3 モード選択画面（mode-select.tsx）
・クイズモード選択: 通常モード / 苦手克服モード
・教科選択: 国語・社会・数学・理科・英語（複数選択可）
・制限時間選択: 5秒 / 10秒 / 30秒 / 60秒
・「スタート」ボタン → クイズ画面へ

4.2.4 クイズ画面（quiz.tsx）
・問題文と4択の選択肢を表示
・タイマー表示（プログレスバー形式）
・進捗表示（例: 3 / 10）
・正解/不正解のフィードバック（色、バイブレーション）
・一時停止ボタン（⏸）→ 問題を隠してタイマー停止
・終了ボタン（✕）→ 確認ダイアログ後、ホームへ

4.2.5 結果画面（result.tsx）
・グレード表示（S/A/B/C/D）
・スコア、正解数、正答率を表示
・AI診断（がくまるからのアドバイス）
・「苦手分野をもう一度挑戦!」ボタン（間違えた教科で補習クイズ）
・「結果をシェア」ボタン → シェアモーダル
・「もう一度」「トップへ」ボタン

4.2.6 ランキング画面（ranking.tsx）
・期間切り替え: 週間 / 月間 / 累計
・順位、ニックネーム、スコアを一覧表示
・自分の順位をハイライト

4.2.7 マイページ画面（mypage.tsx）
・ニックネーム表示・変更
・総合成績（総問題数、正解数、正答率）
・教科別成績
・招待QRコード生成


5. 機能仕様
-----------

5.1 クイズ機能

5.1.1 出題ロジック
・選択された教科から問題を出題
・1セッション10問
・通常モード: ランダム出題
・苦手克服モード: 過去に間違えた問題を優先出題

5.1.2 スコア計算
・基礎点: 正解1問につき100点
・時間ボーナス: 残り時間(秒) × 10点（上限は制限時間×10）
・計算式: スコア = Σ(正解問題ごとに 100 + 残り秒数 × 10)
・例: 30秒制限で残り20秒で正解 → 100 + 200 = 300点
・最高スコアはモード・教科・制限時間の組み合わせごとに記録

5.1.3 グレード判定
・S: 正答率 90%以上
・A: 正答率 80%以上90%未満
・B: 正答率 70%以上80%未満
・C: 正答率 60%以上70%未満
・D: 正答率 60%未満

5.1.4 苦手判定条件
・対象: 過去に2回以上回答した問題
・判定: 正答率50%未満を「苦手」とする
・優先度: 正答率が低いほど優先的に出題

5.1.5 タイマー機能（useTimer.ts）
・選択した制限時間でカウントダウン
・時間切れ時は不正解として処理
・一時停止・再開が可能

5.2 AI成績診断機能

5.2.1 処理フロー
1. クイズ終了時に回答データを収集
2. OpenAI API（GPT-4o-mini）に送信
3. パーソナライズされた講評を生成
4. 結果画面に表示

5.2.2 講評の特徴
・中学生に親しみやすい文体
・150〜300文字程度
・よくできた点、改善ポイント、アドバイスを含む
・APIエラー時は定型文を表示

5.3 補習クイズ機能（敗者復活戦）

・結果画面で間違えた問題がある場合に表示
・間違えた教科から苦手克服モードでクイズを開始
・外部教材誘導ではなくアプリ内で完結

5.4 一時停止・中断機能

5.4.1 一時停止
・右上の「⏸」ボタンで発動
・タイマーを停止
・問題をモーダルで隠す（カンニング防止）
・「再開する」ボタンで続行

5.4.2 中断
・右上の「✕」ボタンで発動
・確認ダイアログ「本当にやめますか？」
・「やめる」選択でホーム画面へ戻る
・途中経過は保存されない

5.5 シェア機能

5.5.1 結果画像生成
・react-native-view-shotで画面をキャプチャ
・スコア、正答率、マスコット「がくまる」を含むデザイン

5.5.2 SNSシェア
・expo-sharingでシステムシェアシートを表示
・LINE、X、Instagram等へ共有可能

5.5.3 招待機能
・アプリ招待用QRコードを生成
・ディープリンクで招待

5.6 ランキング機能

・Supabaseにスコアを保存
・週間/月間/累計で集計
・匿名（ニックネーム）で表示
・友達間ランキングは見送り（いじめ問題への配慮）


6. データ設計
-------------

6.1 ローカルストレージ（AsyncStorage）

キー                    | 内容
-----------------------|----------------------------------
user_profile           | ニックネーム、デバイスID
question_stats         | 問題ごとの正答履歴
high_scores            | モード・教科・時間別のハイスコア
last_quiz_result       | 直近のクイズ結果（AI診断用）

6.2 Supabase テーブル

6.2.1 questions（問題データ）
・id: UUID
・subject: 教科（japanese/social/math/science/english）
・question: 問題文
・choices: 選択肢（配列）
・correct_answer: 正解インデックス
・difficulty: 難易度

6.2.2 scores（スコアデータ）
・id: UUID
・device_id: デバイスID
・nickname: ニックネーム
・score: スコア
・mode: モード
・subjects: 教科
・created_at: 作成日時


7. セキュリティ・プライバシー
----------------------------

7.1 ユーザー認証
・メールアドレス不要（中学生への配慮）
・ニックネーム制（任意入力）
・デバイスIDで識別（ユーザーには非表示）

7.2 データ保護
・個人を特定できる情報は取得しない
・ニックネームは不適切表現をフィルタリング
・OpenAI APIへの送信データは匿名化

7.3 COPPA準拠（児童オンラインプライバシー保護法）

7.3.1 取得するデータ
・ニックネーム（任意、本名不要）
・デバイスID（自動生成、端末識別用）
・クイズ回答履歴（問題ID、正誤、回答時間）
・スコア、正答率

7.3.2 取得しないデータ
・氏名、住所、電話番号
・メールアドレス
・学校名、学年、クラス
・位置情報
・写真、音声

7.3.3 データ保持・削除
・ローカルデータ: アプリ削除時に自動消去
・サーバーデータ: ニックネーム、スコアのみ（匿名）
・削除依頼: 問い合わせ窓口にて対応（要device_id）
・保持期間: 1年間（それ以降は自動削除を検討）

7.3.4 問い合わせ窓口
・学宝社サポート（メール/電話）で対応
・削除依頼時はdevice_idの提示が必要

7.4 ニックネームフィルタリング

7.4.1 禁止語辞書
・管理主体: 学宝社（ダッシュボードで管理）
・更新頻度: 必要に応じて随時追加
・カテゴリ: 卑猥語、差別語、暴力的表現、個人情報的表現

7.4.2 フィルタリング対象
・完全一致
・ひらがな/カタカナ変換後の一致
・記号除去後の一致

7.4.3 NG時のUI
・「このニックネームは使用できません」と表示
・具体的な理由は表示しない（回避防止）
・別のニックネームを提案しない（安全側に倒す）


8. 開発・運用
-------------

8.1 開発コマンド

```
npm install              # 依存関係インストール
npm start                # Expo開発サーバー起動
npm run ios              # iOSシミュレータ起動
npm run android          # Androidエミュレータ起動
```

8.2 ビルド・配布

```
eas build --platform all --profile preview    # プレビュービルド
eas build --platform all --profile production # 本番ビルド
```

8.3 社内配布フロー

1. ビルド完了後、docs/qr_android.png と qr_ios.png を更新
2. SlackでQRコード画像を共有
3. テスターは端末でQRコードをスキャン
4. 表示されたリンクからインストール

8.4 問題データ管理

・問題の追加・編集・削除は学宝社ダッシュボードで実施
・アプリはSupabaseから問題データを取得
・フォールバック用にローカルにも問題データを保持


9. 非機能要件
-------------

9.1 性能要件
・アプリ起動: 3秒以内（スプラッシュ表示後）
・画面遷移: 500ms以内
・クイズ開始: 問題データ取得後1秒以内
・AI診断: 10秒以内（タイムアウト時は定型文表示）

9.2 可用性
・外部API障害時: 定型文でフォールバック（AI診断）
・ランキング投稿失敗時: 本体機能は継続、投稿は破棄
・Supabase障害時: ローカル問題データで継続

9.3 オフライン時の挙動

9.3.1 初回起動時（Supabase接続不可）
・ローカル問題データ（data/questions.ts）で開始可能
・ランキング機能は利用不可（エラー表示）
・AI診断は定型文を表示

9.3.2 問題データのキャッシュ
・キャッシュ期間: 24時間
・優先順位: Supabase > ローカルキャッシュ > 静的データ
・キャッシュ更新: アプリ起動時に自動取得

9.3.3 ランキング投稿失敗時
・リトライ: なし（即時破棄）
・ユーザー通知: なし（サイレント）
・理由: 中学生向けのため複雑なリトライUIは避ける

9.4 ログ・監視
・クラッシュログ: 将来的にSentry等の導入を検討
・個人情報: ログに含めない
・Edge Function監視: 呼び出し回数・失敗率を確認


10. リリース前 要対応事項（重要）
---------------------------------

以下はセキュリティ上の課題であり、本番リリース前に必ず対応が必要。

10.1 OpenAI APIキーの保護（優先度: 最高）

現状の問題:
・EXPO_PUBLIC_プレフィックスによりAPIキーがクライアントに埋め込まれる
・アプリを解析されるとAPIキーが流出するリスク

対応方針:
・Supabase Edge Function「ai_feedback」を作成
・アプリはEdge Functionを呼び出し、OpenAIキーはサーバ側のみ保持
・Edge FunctionでレートLimiting、入力サイズ制限を実施

Edge Function仕様（予定）:
・エンドポイント: /functions/v1/ai_feedback
・入力: { answers: AnsweredQuestion[], totalScore: number }
・出力: { comment, strengths, weaknesses, advice }
・認証: device_idによる簡易認証
・制限: 1デバイスあたり10回/時間

10.2 ランキング不正対策（優先度: 高）

現状の問題:
・認証なしでscoresテーブルに書き込み可能
・クライアント側のスコア値をそのまま信用している
・不正に高スコアを投稿される可能性

対応方針:
・スコア登録はRPC（Stored Procedure）経由に変更
・サーバ側で回答ログからスコアを再計算
・device_idごとの連投制限（1分間に1回まで）

RLS（Row Level Security）方針:
・questions: 全員読み取り可、書き込み不可
・scores: 全員読み取り可、書き込みはRPC経由のみ

10.3 対応スケジュール（案）
・フェーズ4着手前に上記2点を完了させる
・テスト環境で検証後、本番適用


11. QA・受入基準
----------------

11.1 画面別チェックリスト

ホーム画面:
・[ ] ロゴ、マスコット画像が表示される
・[ ] 各ボタンが正常に遷移する
・[ ] 初回起動時はニックネーム画面へ遷移

モード選択画面:
・[ ] 教科を1つ以上選択しないとスタート不可
・[ ] 制限時間の選択が反映される

クイズ画面:
・[ ] タイマーが正しくカウントダウン
・[ ] 選択後に正解/不正解が表示される
・[ ] 一時停止で問題が隠れる
・[ ] 中断確認ダイアログが表示される

結果画面:
・[ ] スコア、正答率、グレードが正しい
・[ ] AI診断が表示される（またはフォールバック）
・[ ] 間違えた場合のみ補習クイズボタン表示

11.2 例外系テスト

・[ ] ネットワーク不通時: ローカルデータで動作
・[ ] API タイムアウト時: 定型文表示
・[ ] 中断→復帰時: 途中経過は破棄（仕様通り）
・[ ] バックグラウンド→復帰時: タイマー継続

11.3 受入基準

・全画面でクラッシュしないこと
・主要フローが正常に完了すること
・オフライン時もクイズが遊べること
・中学生が迷わず操作できるUIであること


12. 今後の拡張計画
------------------

フェーズ1（完了）: 基本機能の完成
フェーズ2（完了）: AI成績診断実装
フェーズ3（完了）: シェア機能・ランキング実装
フェーズ3.5（完了）: 補習クイズ機能、一時停止・中断機能
フェーズ4: 苦手克服オンライン教材の開発
フェーズ5: 問題数拡充、学校単位での導入対応

※フェーズ4着手前に「10. リリース前 要対応事項」を完了させること


13. 変更履歴
------------

日付         | 変更内容
------------|--------------------------------------------------
2025-12-25  | 初版作成
2025-12-25  | AI成績診断機能追加
2025-12-25  | シェア機能・ランキング・マイページ実装
2025-12-25  | 管理画面削除（ダッシュボードで管理）
2025-12-25  | 補習クイズ機能・一時停止/中断機能実装
2025-12-25  | 副教材レコメンド機能削除（補習クイズに置換）
2025-12-25  | 仕様書強化: 数値定義、COPPA詳細、非機能要件、
            | リリース前要対応事項、QA基準を追加


以上
